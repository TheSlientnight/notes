# 简介
本文档重点对pipeline做介绍
## 1. 参考资料
- 官网： https://www.jenkins.io/
- 文档： https://www.jenkins.io/doc/
- 下载： https://www.jenkins.io/download/
- docker部署文档： https://github.com/jenkinsci/docker/blob/master/README.md
- w3c文档： https://www.w3cschool.cn/jenkins/jenkins-5h3228n2.html

## 2. 容器化部署
- 基础部署：`docker run -u root -d -v jenkins_home:/var/jenkins_home -p 8080:8080 -p 50000:50000 jenkins/jenkins:lts`
- BlueOcean版jenkins(推荐): `docker run -u root --rm -d -p 8080:8080 -p 50000:50000 -v jenkins-data:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock jenkinsci/blueocean`

2. 查看初始token: `docker logs <jenkins的容器>`

## 3. 插件
1. 修改插件源
    - 将插件源改为国内源将会下载更快：插件管理-高级-升级站点
    - 源： `https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json` 

2. 安装`Role-based Authorization Strategy`插件进行权限管理

# Jenkins pipeline
## 1. 概念理解

1. Jenkins Pipeline总体介绍
- Pipeline，简而言之，就是一台运行于Jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。
- Pipeline是Jenkins2.X最核心的特性，帮助Jenkins实现从CI到CD与DevOps的转变。
- 详细介绍可见https://jenkins.io/2.0
2. 什么是Jenkins Pipeline
- Jenkins Pipeline是一组插件，让Jenkins可以实现持续交付管道的落地和实施。
- 持续交付管道（CD Pipeline）是将软件从版本控制阶段到交付给用户或客户的完整过程的自动化表现。
- Pipeline提供了一组可扩展的工具，通过Pipeline Domain Specific Language（DSL）syntax可以达到Pipeline as Code的目的
- Pipeline as Code： Jenkinsfile 存储在项目的源代码库
3. Jenkins Pipeline核心概念
- Stage
    - 阶段，一个Pipeline可以划分为若干个Stage，每个Stage代表一组操作，如：“Build”，“Test”， "Deploy"。
    - 注意，Stage是一个逻辑分组的概念，可以跨多个Node。
- Node
    - 节点，一个Node就是一个Jenkins节点，或者是Master，或者是Agent。是执行Step的具体运行环境 。
- Step
    - 步骤，Step是 最基本的操作单元，小到创建一个目录，大到构建一个Docker镜像，由各类 Jenkins Plugin提供，例如：sh 'make'
 
4. 为什么要用Pipeline？
- 代码（Code）: Pipeline以代码的形式实现，通常被检入源代码控制，是团队能够编辑，审查 和迭代其CD流程。
- 可持续性（Durable）：Jenkins重启或者中断后都不会影响Pipeline Job。
- 可停顿（Pausable）:Pipeline可以选择停止并等待人工输入或者批准，然后再继续Pipeline运行。
- 多功能（Versatile）：Pipeline支持实现现实世界的复杂CD要求，包括fork/join子进程，循环和并行执行工作的能力。
- 可拓展（Extensible）：Pipeline插件支持其DSL的自定义扩展及与其他插件集成的多个选项。

## 2. 语法
tips: 本笔记只涉略声明式pipeline, 不对脚本式示例

```groovy
pipeline {
    agent any // 执行者

    stages {
        stage('Build') {  // 阶段
            steps {  // 步骤
                sh 'make' 
            }
        }
        stage('Test'){
            steps {
                sh 'make check'
                junit 'reports/**/*.xml' 
            }
        }
        stage('Deploy') {
            steps {
                sh 'make publish'
            }
        }
    }
}
```







**jenkins自带语法生成器: `http://jenkinsUrl:Port/pipeline-syntax/`**
![](./images/pipeline_syntax.png)
### 1. shell命令

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'echo "Hello World"' // 执行单条命令
                sh '''
                    echo "Multiline shell steps works too"
                    ls -lah
                '''//执行多条命令
            }
        }
    }
}
```

### 2. 超时&重试
![](./images/pipeline_timeout.png)
```groovy
pipeline {
    agent any
    stages {
        stage('Deploy') {
            steps {
                retry(3) {  // 重试3次
                    sh './flakey-deploy.sh'
                }

                timeout(time: 3, unit: 'MINUTES') {  // 超时时间(3分钟)
                    sh './health-check.sh'
                }
            }
        }
    }
}
```
unit常用选项:
- SECONDS
- MINUTES
- HOURS
- DAYS


**也可以进行互相嵌套使用**
```groovy
pipeline {
    agent any
    stages {
        stage('Deploy') {
            steps {
                timeout(time: 3, unit: 'MINUTES') {
                    retry(5) {
                        sh './flakey-deploy.sh'
                    }
                }
            }
        }
    }
}
```

### 3. post 根据构建状态而执行
![](./images/pipeline_post.png)

```groovy
pipeline {
    agent any
    stages {
        stage('ignore') {
            steps {
                echo "hello_word"
            }
        }
    }
    post {
        always {
            echo 'This will always run'
        }
        success {
            echo 'This will run only if successful'
        }
        failure {
            echo 'This will run only if failed'
        }
        unstable {
            echo 'This will run only if the run was marked as unstable'
        }
        changed {
            echo 'This will run only if the state of the Pipeline has changed'
            echo 'For example, if the Pipeline was previously failing but is now successful'
        }
    }   
}
```

### 4. agent 代理/执行者/工作区
以下意思为：启动指定容器并进入执行shell命令
```groovy
pipeline {
    agent {
        docker { image 'node:7-alpine' }
    }
    stages {
        stage('Test') {
            steps {
                sh 'node --version'
            }
        }
    }
}
```
### 5. environment 环境变量

```groovy
pipeline {
    agent any

    environment {
        DISABLE_AUTH = 'true'
        DB_ENGINE    = 'sqlite'
    }

    stages {
        stage('Build') {
            steps {
                echo 'DB_ENGINE'
            }
        }
    }
}
```

### 6. 凭证使用 credentials

![](./images/pipeline_token.png)
不同的凭证类型语法上有些许变化，以语法生成器的为准
```groovy
pipeline {
    agent any
    environment {
    // 以下方法仅适用于声明式脚本
    // Secret text
    SONARQUBE_TOKEN = credentials('SONARQUBE_TOKEN')
    // Username with password
    SONARQUBE_ACCESS = credentials('SONARQUBE_ACCESS')
    }
    stages {
        stage('DEMO1') {
            steps {
                // 以下方法仅适用于声明式脚本
                echo ${SONARQUBE_TOKEN}  // 输出token
                echo ${SONARQUBE_ACCESS} // 输出账号和密码
                echo ${SONARQUBE_ACCESS_USR}  // 输出账号
                echo ${SONARQUBE_ACCESS_PSW}  // 输出密码
            }
        }
        stage('DEMO2') {
            steps {
                // 此方法都适用
                withCredentials([string(credentialsId: 'SONARQUBE_TOKEN', variable: 'TOKEN')]) {  // 创建凭证环境
                    echo ${TOKEN}
                }
            }
        }
    }
}

```

### 7. 通知

安装相关插件可实现邮件发送或者机器人通知
```groovy
post {
    failure {  // 发送邮件
        mail to: 'team@example.com',  // 送达目标
             subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",  //邮件标题
             body: "Something is wrong with ${env.BUILD_URL}" // 正文内容
    }
}
```

### 8. input 输入
```groovy
stage('Sanity check') {
    steps {
        input "Does the staging environment look ok?"
    }
}
```

### 全局变量
jenkins自带全局变量文档: `http://jenkinsUrl:Port/job/test/pipeline-syntax/globals`

### checkout 检查scm

```groovy
stage('checkout'){
    steps{
        checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/fungaegis/notes.git']]])
    }
}
```
### 其他
deleteDir() 清理当前job在workspace中的文件


## 3. jenkinsfile

```groovy
#!/usr/bin/env groovy Jenkinsfile
```












```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```
```groovy

```

