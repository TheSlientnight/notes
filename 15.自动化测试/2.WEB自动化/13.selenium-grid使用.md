官方文档:https://github.com/SeleniumHQ/selenium/wiki/Grid2

# 1.使用背景:
selenium有三个核心组件: IDE, WebDriver, Grid.

Grid是开源selenium工具集的一部分，允许你在多台机器的多个浏览器上并行的进行测试，也就是说，你可以同时运行多个测试。本质上来说就是，selenium grid支持分布式的测试执行。它可以让你的测试在一个分布式的执行环境中运行

常用场景
- 多浏览器,多系统兼容测试
- 多用例量,减少运行时间,并发运行

# 2.使用说明
- `http://localhost:port/grid/console`: master端控制页面
- `http://localhost:port/grid/register`: node向hub注册地址
- `http//localhost:port/wd/hub`: 脚本连接地址

## 1.命令行配置

- `java -jar selenium-server-standalone-<version>.jar -role hub`: 启动hub服务
- `java -jar selenium-server-standalone-<version>.jar -role node  -hub http://localhost:4444/grid/register`: 启动node服务

参数:
- `-port`: 自定义端口,hub默认为4444,node默认为5555
- `-host`: 自定义host 一般情况下不需要
- `-timeout`: 默认为300秒,若该秒内为接到新的命令则释放当前session
- `-maxSession`: 默认最大会话数为5, 整个node的总最大实例数
- `-browser`: 浏览器参数,默认为5个Firefox,1个chrome,1个IE(如果是WIN).可以多次使用该选项
    - browserName: 浏览器类型 {android，chrome，firefox，htmlunit，Internet Explorer，iphone，Opera} 上述中选一个
    - version: 浏览器版本
    - firefox_binary: 可执行二进制文件的路径
    - chrome_binary: 可执行二进制文件的路径
    - maxInstances: 该浏览器最大实例数
    - platform: 系统平台 {WINDOWS，LINUX，MAC}, 若webdriver的cap为"ANY"则全都可以运行
    - registerCycle: 轮询注册频率(毫秒),重启hub时自动连接
- `-DPOOL_MAX`: 当node大于50个时需要额外增大

browser使用示例:
- `-browser browserName=firefox,version=3.6,platform=LINUX`
- `-browser browserName=firefox,version=3.6,maxInstances=5,platform=LINUX`
- `-browser browserName=firefox,version=3.6,firefox_binary=/home/myhomedir/firefox36/firefox,maxInstances=3,platform=LINUX -browser browserName=firefox,version=4,firefox_binary=/home/myhomedir/firefox4/firefox,maxInstances=4,platform=LINUX`

## 2.json配置

hub节点配置示例: https://github.com/SeleniumHQ/selenium/blob/selenium-3.141.59/java/server/src/org/openqa/grid/common/defaults/DefaultHub.json

Node节点配置示例: https://github.com/SeleniumHQ/selenium/blob/selenium-3.141.59/java/server/src/org/openqa/grid/common/defaults/DefaultNodeWebDriver.json


- `java -jar selenium-server-standalone.jar -role node -nodeConfig nodeconfig.json`
- `java -jar selenium-server-standalone.jar -role hub -hubConfig hubconfig.json`

hub的json配置
```json
{
  "port": 4444,
  "newSessionWaitTimeout": -1,
  "servlets" : [],
  "withoutServlets": [],
  "custom": {},
  "capabilityMatcher": "org.openqa.grid.internal.utils.DefaultCapabilityMatcher",
  "registry": "org.openqa.grid.internal.DefaultGridRegistry",
  "throwOnCapabilityNotPresent": true,
  "cleanUpCycle": 5000,
  "role": "hub",
  "debug": false,
  "browserTimeout": 0,
  "timeout": 1800
}
```
- throwOnCapabilityNotPresent: 默认为true，如果为true则hub只有在当前有测试代理注册的情况下才会接受测试请求；如果为false则如果当前没有代理注册也会接受请求保存到队列直到有代理注册为止。
- capabilityMatcher: 该类用于实现grid在分布测试任 务到对应代理时所使用的匹配规则
- port: hub监听的端口
- host: hub的host
- newSessionWaitTimeout: 默认-1，即没有间隔；指定一个新的测试session等待执行的间隔时间。即一个代理节点上前后2个会话中间的延时时间，单位为毫秒。
- servlets: 在hub上注册一个新的servlets，访问地址为/grid/admin/XXXservlets
- browserTimeout: 浏览器无响应的超时时间
- cleanUpCycle: 代理节点检查超时的周期
- timeout: 会话超时时间



node的json配置
```json
{
  "capabilities":
  [
    {
      "browserName": "firefox",
      "marionette": true,
      "maxInstances": 5,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "chrome",
      "maxInstances": 5,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "internet explorer",
      "platform": "WINDOWS",
      "maxInstances": 1,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "safari",
      "technologyPreview": false,
      "platform": "MAC",
      "maxInstances": 1,
      "seleniumProtocol": "WebDriver"
    }
  ],
  "proxy": "org.openqa.grid.selenium.proxy.DefaultRemoteProxy",
  "maxSession": 5,
  "port": -1,
  "register": true,
  "registerCycle": 5000,
  "hub": "http://localhost:4444",
  "nodeStatusCheckTimeout": 5000,
  "nodePolling": 5000,
  "role": "node",
  "unregisterIfStillDownAfter": 60000,
  "downPollingLimit": 2,
  "debug": false,
  "servlets" : [],
  "withoutServlets": [],
  "custom": {}
}
```
- hub: hub的host和port
- registerCycle: 代理节点自动重新注册的周期，单位毫秒；适应于重启了hub时不需要重启所有的代理节点。
- nodePolling: hub检查代理节点的周期
- unregisterIfStillDownAfter: 单位毫秒，设定代理节点在无响应多长时间后hub才会注销代理节点注册信息
- maxSession: 一个代理节点可以同时启动的浏览器最大数量，即session数量


# 3.匹配逻辑&代码实例
1. 脚本设置cap参数,通过脚本实例化webdriver时的capabilities参数匹配node

```py
from selenium.webdriver.
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities


selenium_grid_url = "http://198.0.0.1:4444/wd/hub"
capabilities = DesiredCapabilities.FIREFOX.copy()
capabilities['platform'] = "WINDOWS"
capabilities['version'] = "10"
driver = webdriver.Remote(desired_capabilities=capabilities, command_executor=selenium_grid_url)
```
例如以上脚本将匹配到

`-browser  browserName=firefox,version=10,platform=WINDOWS`

若不能匹配则无法运行


2. 一个session(一个实例WebDriver), hub只会分配到一个node的实例中

# 4. docker构建
因为grid4还未完善,本文章主要介绍grid3的使用


支持docker运行的浏览器版本: https://github.com/SeleniumHQ/docker-selenium/releases

docker-selenium: https://github.com/SeleniumHQ/docker-selenium/tree/selenium-3

e.g.
```shell
# 创建网络
docker network create grid  
# 运行hub
docker run -d -p 4444:4444 --net grid --name selenium-hub selenium/hub
# 运行同服务器node
docker run -d --net grid -e HUB_HOST=selenium-hub -v /dev/shm:/dev/shm selenium/node-chrome
# 运行不同服务器node
docker run -d -p <node_port>:5555 -e HUB_HOST=<hub_ip|hub_name> -e HUB_PORT=4444 -e REMOTE_HOST="http://<node_ip|node_name>:<node_port>" selenium/node-firefox:3.141.59-20210128
# 运行debug版本node,带vnc
docker run -d -P --net grid -e HUB_HOST=selenium-hub -v /dev/shm:/dev/shm selenium/node-chrome-debug
```


## 环境变量选项:
官方文档没有说明解释,只有在dockerfile里面有说明,真是让我一顿好找

hub: https://github.com/SeleniumHQ/docker-selenium/blob/selenium-3/Hub/Dockerfile

node: https://github.com/SeleniumHQ/docker-selenium/blob/selenium-3/NodeBase/Dockerfile

hub:

```dockerfile
# As integer, maps to "maxSession"  grid的总会话数,该数会限制住node的会话总数
ENV GRID_MAX_SESSION 5
# In milliseconds, maps to "newSessionWaitTimeout"  新会话间隔
ENV GRID_NEW_SESSION_WAIT_TIMEOUT -1
# As a boolean, maps to "throwOnCapabilityNotPresent"
ENV GRID_THROW_ON_CAPABILITY_NOT_PRESENT true
# As an integer
ENV GRID_JETTY_MAX_THREADS -1
# In milliseconds, maps to "cleanUpCycle"  代理节点检查超时的周期
ENV GRID_CLEAN_UP_CYCLE 5000
# In seconds, maps to "browserTimeout"  浏览器无响应的超时时间
ENV GRID_BROWSER_TIMEOUT 0
# In seconds, maps to "timeout"  会话超时时间
ENV GRID_TIMEOUT 1800
# Debug
ENV GRID_DEBUG false
# As integer, maps to "port"  hub的端口
ENV GRID_HUB_PORT 4444
# As string, maps to "host"  hub的host,在docker运行的时候,只能拿到内网地址,如果需要跨服务器连接需要手动填写
ENV GRID_HUB_HOST "0.0.0.0"
```

node:

```dockerfile
#============================
# Some configuration options
#============================
# 宽度
ENV SCREEN_WIDTH 1360
# 高度
ENV SCREEN_HEIGHT 1020
# 色阶
ENV SCREEN_DEPTH 24
# 像素点
ENV SCREEN_DPI 96
# 展示
ENV DISPLAY :99.0
# XVFB服务,如果使用无头模式,关闭该服务会更省资源
ENV START_XVFB true

#========================
# Selenium Configuration
#========================
# As integer, maps to "maxInstances"  最大实例数
ENV NODE_MAX_INSTANCES 1
# As integer, maps to "maxSession"  最大会话数
ENV NODE_MAX_SESSION 1
# As address, maps to "host"  节点的host
ENV NODE_HOST 0.0.0.0
# As integer, maps to "port"  节点的端口
ENV NODE_PORT 5555
# In milliseconds, maps to "registerCycle"  自动重新注册的周期
ENV NODE_REGISTER_CYCLE 5000
# In milliseconds, maps to "nodePolling"  节点轮询hub时间
ENV NODE_POLLING 5000
# In milliseconds, maps to "unregisterIfStillDownAfter"  超时注销时间
ENV NODE_UNREGISTER_IF_STILL_DOWN_AFTER 60000
# As integer, maps to "downPollingLimit"
ENV NODE_DOWN_POLLING_LIMIT 2
# As string, maps to "applicationName"
ENV NODE_APPLICATION_NAME ""
# Debug
ENV GRID_DEBUG false

# Following line fixes https://github.com/SeleniumHQ/docker-selenium/issues/87
ENV DBUS_SESSION_BUS_ADDRESS=/dev/null
```
- `REMOTE_HOST="http://<node_ip|node_name>:<node_port>"`: 也许可以用NODE_HOST和NODE_PORT代替

# .注意事项:
1. 使用并发运行用例时,请确保webdriver资源独立
2. 使用库中自带cap配置时注意深拷贝,避免产生全局影响`capabilities = DesiredCapabilities.FIREFOX.copy()`
3. 建议在grid上设置timeout的情况下，也应该设置隐形等待超时时间`driver.implicitly_wait(30)`


对影音视频支持
chrome_options.add_argument("--use-fake-ui-for-media-stream")
chrome_options.add_argument("--use-fake-device-for-media-stream")