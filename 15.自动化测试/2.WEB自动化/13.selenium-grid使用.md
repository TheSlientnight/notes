官方文档:https://github.com/SeleniumHQ/selenium/wiki/Grid2

# 1.使用背景:
selenium有三个核心组件: IDE, WebDriver, Grid.

Grid是开源selenium工具集的一部分，允许你在多台机器的多个浏览器上并行的进行测试，也就是说，你可以同时运行多个测试。本质上来说就是，selenium grid支持分布式的测试执行。它可以让你的测试在一个分布式的执行环境中运行

常用场景
- 多浏览器,多系统兼容测试
- 多用例量,减少运行时间,并发运行

# 2.使用说明
- `http//localhost:port/grid/console`: 控制页面
- `http://localhost:port/grid/register`: node向hub注册地址
- `http//localhost:port/wd/hub`: 脚本连接地址

## 1.命令行配置

- `java -jar selenium-server-standalone-<version>.jar -role hub`: 启动hub服务
- `java -jar selenium-server-standalone-<version>.jar -role node  -hub http://localhost:4444/grid/register`: 启动node服务
    - `-browser browserName=firefox,version=3.6,platform=LINUX`
    - `-browser browserName=firefox,version=3.6,maxInstances=5,platform=LINUX`
    - `-browser browserName=firefox,version=3.6,firefox_binary=/home/myhomedir/firefox36/firefox,maxInstances=3,platform=LINUX -browser browserName=firefox,version=4,firefox_binary=/home/myhomedir/firefox4/firefox,maxInstances=4,platform=LINUX`


参数:
- `-port`: 自定义端口,hub默认为4444,node默认为5555
- `-host`: 自定义host 一般情况下不需要
- `-timeout`: 默认为300秒,若该秒内为接到新的命令则释放当前session
- `-maxSession`: 默认最大会话数为5, 整个node的总最大实例数
- `-browser`: 浏览器参数,默认为5个Firefox,1个chrome,1个IE(如果是WIN).可以多次使用该选项
    - browserName: 浏览器类型 {android，chrome，firefox，htmlunit，Internet Explorer，iphone，Opera} 上述中选一个
    - version: 浏览器版本
    - firefox_binary: 可执行二进制文件的路径
    - chrome_binary: 可执行二进制文件的路径
    - maxInstances: 该浏览器最大实例数
    - platform: 系统平台 {WINDOWS，LINUX，MAC}, 若webdriver的cap为"ANY"则全都可以运行
    - registerCycle: 轮询注册频率(毫秒),重启hub时自动连接
- `-DPOOL_MAX`: 当node大于50个时需要额外增大

## 2.json配置

hub节点配置示例: https://github.com/SeleniumHQ/selenium/blob/selenium-3.141.59/java/server/src/org/openqa/grid/common/defaults/DefaultHub.json

Node节点配置示例: https://github.com/SeleniumHQ/selenium/blob/selenium-3.141.59/java/server/src/org/openqa/grid/common/defaults/DefaultNodeWebDriver.json


- `java -jar selenium-server-standalone.jar -role node -nodeConfig nodeconfig.json`
- `java -jar selenium-server-standalone.jar -role hub -hubConfig hubconfig.json`

hub的json配置
```json
{
  "port": 4444,
  "newSessionWaitTimeout": -1,
  "servlets" : [],
  "withoutServlets": [],
  "custom": {},
  "capabilityMatcher": "org.openqa.grid.internal.utils.DefaultCapabilityMatcher",
  "registry": "org.openqa.grid.internal.DefaultGridRegistry",
  "throwOnCapabilityNotPresent": true,
  "cleanUpCycle": 5000,
  "role": "hub",
  "debug": false,
  "browserTimeout": 0,
  "timeout": 1800
}
```

node的json配置
```json
{
  "capabilities":
  [
    {
      "browserName": "firefox",
      "marionette": true,
      "maxInstances": 5,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "chrome",
      "maxInstances": 5,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "internet explorer",
      "platform": "WINDOWS",
      "maxInstances": 1,
      "seleniumProtocol": "WebDriver"
    },
    {
      "browserName": "safari",
      "technologyPreview": false,
      "platform": "MAC",
      "maxInstances": 1,
      "seleniumProtocol": "WebDriver"
    }
  ],
  "proxy": "org.openqa.grid.selenium.proxy.DefaultRemoteProxy",
  "maxSession": 5,
  "port": -1,
  "register": true,
  "registerCycle": 5000,
  "hub": "http://localhost:4444",
  "nodeStatusCheckTimeout": 5000,
  "nodePolling": 5000,
  "role": "node",
  "unregisterIfStillDownAfter": 60000,
  "downPollingLimit": 2,
  "debug": false,
  "servlets" : [],
  "withoutServlets": [],
  "custom": {}
}
```

# 3.匹配逻辑&代码实例
1. 脚本设置cap参数,通过脚本实例化webdriver时的capabilities参数匹配node

```py
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities


selenium_grid_url = "http://198.0.0.1:4444/wd/hub"
capabilities = DesiredCapabilities.FIREFOX.copy()
capabilities['platform'] = "WINDOWS"
capabilities['version'] = "10"
driver = webdriver.Remote(desired_capabilities=capabilities, command_executor=selenium_grid_url)
```
例如以上脚本将匹配到
`-browser  browserName=firefox,version=10,platform=WINDOWS`
若不能匹配则无法运行


2. 一个session(一次实例化)只会运行在一个node的实例中

# 4. docker构建



# .注意事项:
1. 使用并发运行用例时,请确保webdriver资源独立
2. 使用库中自带cap配置时注意深拷贝,避免产生全局影响`capabilities = DesiredCapabilities.FIREFOX.copy()`
3. 建议在grid上设置timeout的情况下，也应该设置隐形等待超时时间`driver.implicitly_wait(30)`
