# 使用背景
在我们落地app自动化的时,设备问题 环境问题处理起来都非常棘手.迫切需要一个免调试环境的运行环境.

于是我们决定以容器化的形式解决这些问题,将安卓虚拟机与appium serve一并在容器中运行.

在这种情况下也方便我们实现并发运行脚本

# 前置要求
- [selenium grid 可以看web系列文章](../2.WEB自动化/13.selenium-grid使用.md#4.-docker构建)grid起分发的作用
- [第三方appium服务端与安卓虚拟机镜像](https://github.com/budtmo/docker-android)
    - [参数](https://github.com/budtmo/docker-android/blob/master/README_CUSTOM_CONFIG.md)
    - [与grid的使用示例](https://github.com/budtmo/docker-android/blob/master/README_APPIUM_AND_SELENIUM.md)
- [appium服务端官方镜像](https://hub.docker.com/r/appium/appium)
- [jenkins插件](https://github.com/budtmo/jenkins-plugin-vncviewer-docker-container)
- [appium官方文档](http://appium.io/)

# appium官方镜像使用
该镜像只是运行 appium serve,还需要将容器内的程序与设备相连接

本文档只做使用远程adb连接的方法介绍

物理连接的方法有兴趣的可以去[appium服务端官方镜像](https://hub.docker.com/r/appium/appium)查看
## 共享安卓标记key
我们与设备连接的首次往往会有一个标记key,就是一个是否运行当前PC设备进行调试连接的弹窗.

我们需要勾选总是允许并同意,这个key将会存在~/.android中.我们需要将他挂在到每一个容器中,方便以后连接不需要再次认证标记

挂载:
`-v ~/.android:/root/.android`

e.g.
`docker run --privileged -d -p 4723:4723 -v ~/.android:/root/.android -v /dev/bus/usb:/dev/bus/usb --name container-appium appium/appium`

## 连接selenium grid的参数
- CONNECT_TO_GRID=true
- APPIUM_HOST=<ip_address_of_appium_server>
- APPIUM_PORT=<port_of_appium_server>
- SELENIUM_HOST=<ip_address_of_selenium_hub>
- SELENIUM_PORT=<port_of_selenium_hub>

## 远程连接


`docker run -d -p 4723:4723 -e REMOTE_ADB=true -e ANDROID_DEVICES=192.168.0.5:5555,192.168.0.6:5555 -e REMOTE_ADB_POLLING_SEC=60`
- REMOTE_ADB: 远程adb开关
- ANDROID_DEVICES: 远程adb的ip与端口,用","(逗号)进行分隔,可以连接多个设备
- REMOTE_ADB_POLLING_SEC: 检查adb设备的轮询时间

## 通过远端ADB服务连接
`docker run -p 4723:4723 -e "ADB_SERVER_SOCKET=tcp:<device_host_ip>:<adb_server_port>" --name container-appium appium/appium`
- ADB_SERVER_SOCKET: ADB服务的ip:port,默认port为5037

## docker-compose
```yml
  real_device_appium:
    image: appium/appium
    depends_on:
      - selenium_hub
    networks:
      - appium
    privileged: true
    ports:
      - 4723
    volumes:
      - /dev/bus/usb:/dev/bus/usb
      - ~/.android:/root/.android
      - ./:/root/tmp
    environment:
      - CONNECT_TO_GRID=true
      - SELENIUM_HOST=selenium_hub
      - ANDROID_DEVICES=172.16.16.67:5555
      - REMOTE_ADB=true
```


# 第三方镜像
## 与其他镜像的优势
1. 在线预览Docker容器内模拟器
2. 适用于不同设备/皮肤的仿真器，例如三星Galaxy S6，LG Nexus 4，HTC Nexus One等。
3. 能够连接到Selenium Grid
4. 通过使用adb connect从外部容器控制模拟器和设备的能力
5. 通过在线屏幕支持真实设备
6. 能够在测试执行期间录制视频以进行调试
7. 与其他云解决方案集成，例如Genymotion Cloud
8. 具有更多功能的开源

## 支持的镜像
|OS   |Android   |API   |Browser   |Browser version   |Chromedriver   |Image   |Size   |
|:---|:---|:---|:---|:---|:---|:---|:---|
|Linux|5.0.1|21|browser|37.0|2.21|budtmo/docker-android-x86-5.0.1|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-5.0.1.svg)](https://microbadger.com/images/budtmo/docker-android-x86-5.0.1 "Get your own image badge on microbadger.com")|
|Linux|5.1.1|22|browser|39.0|2.13|budtmo/docker-android-x86-5.1.1|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-5.1.1.svg)](https://microbadger.com/images/budtmo/docker-android-x86-5.1.1 "Get your own image badge on microbadger.com")|
|Linux|6.0|23|browser|44.0|2.18|budtmo/docker-android-x86-6.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-6.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-6.0 "Get your own image badge on microbadger.com")|
|Linux|7.0|24|chrome|51.0|2.23|budtmo/docker-android-x86-7.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-7.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-7.0 "Get your own image badge on microbadger.com")|
|Linux|7.1.1|25|chrome|55.0|2.28|budtmo/docker-android-x86-7.1.1|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-7.1.1.svg)](https://microbadger.com/images/budtmo/docker-android-x86-7.1.1 "Get your own image badge on microbadger.com")|
|Linux|8.0|26|chrome|58.0|2.31|budtmo/docker-android-x86-8.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-8.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-8.0 "Get your own image badge on microbadger.com")|
|Linux|8.1|27|chrome|61.0|2.33|budtmo/docker-android-x86-8.1|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-8.1.svg)](https://microbadger.com/images/budtmo/docker-android-x86-8.1 "Get your own image badge on microbadger.com")|
|Linux|9.0|28|chrome|66.0|2.40|budtmo/docker-android-x86-9.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-9.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-9.0 "Get your own image badge on microbadger.com")|
|Linux|10.0|29|chrome|74.0|74.0.3729.6|budtmo/docker-android-x86-10.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-10.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-10.0 "Get your own image badge on microbadger.com")|
|Linux|11.0|30|chrome|83.0|83.0.4103.39|budtmo/docker-android-x86-11.0|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-x86-11.0.svg)](https://microbadger.com/images/budtmo/docker-android-x86-11.0 "Get your own image badge on microbadger.com")|
|All |-|-|-|-|-|budtmo/docker-android-real-device|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-real-device.svg)](https://microbadger.com/images/budtmo/docker-android-real-device "Get your own image badge on microbadger.com")|
|All|All|All|All|All|All|budtmo/docker-android-genymotion|[![](https://images.microbadger.com/badges/image/budtmo/docker-android-genymotion.svg)](https://microbadger.com/images/budtmo/docker-android-genymotion "Get your own image badge on microbadger.com")|

## 支持的设备
Type   | Device Name
-----  | -----
Phone  | Samsung Galaxy S10
Phone  | Samsung Galaxy S9
Phone  | Samsung Galaxy S8
Phone  | Samsung Galaxy S7 Edge
Phone  | Samsung Galaxy S7
Phone  | Samsung Galaxy S6
Phone  | Nexus 4
Phone  | Nexus 5
Phone  | Nexus One
Phone  | Nexus S
Tablet | Nexus 7

## 使用
1. noVNC: http://ip:6080

`docker run --privileged -d -p 6080:6080 -p 5554:5554 -p 5555:5555 -p 4723:4723 --name android-container-appium budtmo/docker-android-real-device`
- 6080: 6080是onVNC,在线预览端口
- 5554: 
- 5555
- 4723: appium server的端口
